{
 "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
 "contentVersion": "1.0.0.0",
 "parameters": {
   "vmName": {
     "type": "string"
   },
   "vmSize": {
     "type": "string"
   },
   "adminUsername": {
     "type": "string"
   },
   "adminPassword": {
     "type": "secureString"
   },
   "vnetName": {
     "type": "string"
   },
   "appSubnetName": {
     "type": "string"
   }
 },
 "resources": [
   {
     "type": "Microsoft.Compute/virtualMachines",
     "apiVersion": "2021-03-01",
     "name": "[parameters('vmName')]",
     "location": "[resourceGroup().location]",
     "dependsOn": [
       "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
     ],
     "properties": {
       "hardwareProfile": {
         "vmSize": "[parameters('vmSize')]"
       },
       "storageProfile": {
         "osDisk": {
           "createOption": "FromImage",
           "managedDisk": {
             "storageAccountType": "Standard_LRS"
           }
         },
         "imageReference": {
           "publisher": "Canonical",
           "offer": "UbuntuServer",
           "sku": "18.04-LTS",
           "version": "latest"
         }
       },
       "osProfile": {
         "computerName": "[parameters('vmName')]",
         "adminUsername": "[parameters('adminUsername')]",
         "adminPassword": "[parameters('adminPassword')]"
       },
       "networkProfile": {
         "networkInterfaces": [
           {
             "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('vmName'), 'nic')]"
           }
         ]
       }
     }
   },
   {
     "type": "Microsoft.Network/networkInterfaces",
     "apiVersion": "2021-02-01",
     "name": "nic",
     "location": "[resourceGroup().location]",
     "dependsOn": [
       "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
       "[resourceId('Microsoft.Network/networkSecurityGroups', 'myNSG')]"
     ],
     "properties": {
       "ipConfigurations": [
         {
           "name": "ipconfig1",
           "properties": {
             "subnet": {
               "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('appSubnetName'))]"
             }
           }
         }
       ],
       "networkSecurityGroup": {
         "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'myNSG')]"
       }
     }
   }
 ]
}
